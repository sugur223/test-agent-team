name: "üîç Auto Review: Codex"

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    if: contains(github.event.pull_request.labels.*.name, 'auto-dev')
    runs-on: [self-hosted, auto-dev]
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr_diff.patch

      - name: Review with Codex
        run: |
          REVIEW_RESULT=$(codex -p "
          „ÅÇ„Å™„Åü„ÅØ„Ç∑„Éã„Ç¢„Ç®„É≥„Ç∏„Éã„Ç¢„Å®„Åó„Å¶„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ

          ‰ª•‰∏ã„ÅÆË¶≥ÁÇπ„Åß„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
          1. „Éê„Ç∞„ÇÑË´ñÁêÜ„Ç®„É©„Éº„Åå„Å™„ÅÑ„Åã
          2. „Çª„Ç≠„É•„É™„ÉÜ„Ç£‰∏ä„ÅÆÂïèÈ°å„Åå„Å™„ÅÑ„Åã
          3. „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÅÆÂïèÈ°å„Åå„Å™„ÅÑ„Åã
          4. „Ç≥„Éº„Éâ„ÅÆÂèØË™≠ÊÄß„Éª‰øùÂÆàÊÄß
          5. „ÉÜ„Çπ„Éà„ÅåÈÅ©Âàá„Å´Êõ∏„Åã„Çå„Å¶„ÅÑ„Çã„Åã
          6. Dockerfile / docker-compose.yml „ÅÆÂ§âÊõ¥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉªÂäπÁéáÊÄß

          „ÄêÈáçË¶Å„Äë„É¨„Çπ„Éù„É≥„Çπ„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà:
          - 1Ë°åÁõÆ„Å´Âà§ÂÆöÁµêÊûú„ÇíË®òËºâ: APPROVE „Åæ„Åü„ÅØ CHANGES_REQUESTED
          - 2Ë°åÁõÆ‰ª•Èôç„Å´„É¨„Éì„É•„Éº„Ç≥„É°„É≥„Éà

          ÂïèÈ°å„Åå„Å™„Åë„Çå„Å∞ APPROVE „Å®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          ËªΩÂæÆ„Å™ÊîπÂñÑÊèêÊ°à„Å†„Åë„ÅÆÂ†¥Âêà„ÇÇ APPROVE „Å®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          „Éê„Ç∞„Éª„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂïèÈ°å„ÉªÈáçÂ§ß„Å™Ë®≠Ë®àÂïèÈ°å„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø CHANGES_REQUESTED „Å®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          --- diff ---
          $(cat /tmp/pr_diff.patch)
          " --approval-mode full-auto)

          echo "$REVIEW_RESULT" > /tmp/review_result.txt

      - name: Submit review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FIRST_LINE=$(head -1 /tmp/review_result.txt)
          BODY=$(tail -n +2 /tmp/review_result.txt)
          FULL_BODY="üîç **Codex Auto Review**

          ${BODY}"

          if echo "$FIRST_LINE" | grep -qi "APPROVE"; then
            gh pr review ${{ github.event.pull_request.number }} \
              --approve --body "$FULL_BODY"
          else
            gh pr review ${{ github.event.pull_request.number }} \
              --request-changes --body "$FULL_BODY"
          fi
