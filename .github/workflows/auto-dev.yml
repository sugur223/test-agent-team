name: "ğŸ¤– Auto Dev: Claude Code"

on:
  issues:
    types: [opened, labeled]

jobs:
  develop:
    if: contains(github.event.issue.labels.*.name, 'auto-dev')
    runs-on: [self-hosted, auto-dev]
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "auto-dev[bot]"
          git config user.email "auto-dev@users.noreply.github.com"

      - name: Setup env
        run: cp .env.example .env

      - name: Ensure Docker is running
        run: docker compose up -d

      - name: Create branch and implement
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          BRANCH="auto/issue-${ISSUE_NUMBER}"
          git checkout -b "$BRANCH"

          ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body -q '.body')

          claude -p "
          ã‚ãªãŸã¯ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®é–‹ç™ºè€…ã§ã™ã€‚
          ä»¥ä¸‹ã®GitHub Issueã®å†…å®¹ã«å¾“ã£ã¦ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
          CLAUDE.md ã®ãƒ«ãƒ¼ãƒ«ã«å¿…ãšå¾“ã£ã¦ãã ã•ã„ã€‚

          ã€é‡è¦ã€‘
          - Docker é–‹ç™ºç’°å¢ƒãŒèµ·å‹•æ¸ˆã¿ã§ã™
          - ãƒ†ã‚¹ãƒˆãƒ»ãƒªãƒ³ãƒˆãƒ»å‹•ä½œç¢ºèªã¯å¿…ãš Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã—ã¦ãã ã•ã„
            ä¾‹: docker compose exec app <ã‚³ãƒãƒ³ãƒ‰> ã¾ãŸã¯ make test / make lint
          - æ–°ã—ã„ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ãŸå ´åˆã¯ Dockerfile ã‚‚æ›´æ–°ã—ã¦ãã ã•ã„
          - DB ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„

          ## Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          å®Ÿè£…ãŒå®Œäº†ã—ãŸã‚‰ã€å¤‰æ›´å†…å®¹ã®æ¦‚è¦ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
          " --allowedTools "Bash,Read,Write,Edit"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "feat: implement issue #${ISSUE_NUMBER}

          ${ISSUE_TITLE}"
            git push origin "$BRANCH"
          else
            echo "å¤‰æ›´ãªã—ã€‚çµ‚äº†ã—ã¾ã™ã€‚"
            exit 0
          fi

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          gh pr create \
            --title "ğŸ¤– Auto: ${ISSUE_TITLE}" \
            --body "## è‡ªå‹•å®Ÿè£… PR

          Closes #${ISSUE_NUMBER}

          Claude Code (Max) ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…ã§ã™ã€‚
          Codex (Pro) ã«ã‚ˆã‚‹è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚

          ---
          âš ï¸ æœ€çµ‚ãƒãƒ¼ã‚¸ã¯æ‰‹å‹•ã§è¡Œã£ã¦ãã ã•ã„ã€‚" \
            --base main \
            --head "auto/issue-${ISSUE_NUMBER}" \
            --label "auto-dev"

      - name: Update Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "in-progress" \
            --remove-label "auto-dev"
